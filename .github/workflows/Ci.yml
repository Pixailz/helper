name: CI

run-name: Update submodule CI/CD

on:
  workflow_dispatch:
    inputs:
      commit_msg:
        required: true
        description: "the commit message to spread"
      git_email:
        required: true
        description: "the email used to commit"

jobs:
  info:
    runs-on: ubuntu-latest
    steps:
      - name: "💬 github"
        run: |+
          echo "Who launched: ${{github.actor}}"
          echo "On branch:    ${{github.ref_name}}"
          echo "Commit sha:   ${{github.sha}}"

      - name: "💬 Bin utils"
        run: |+
          make --version && echo
          ar --version && echo
          gcc --verbose && echo
          python3 --version

  prepare-test:
    runs-on: ubuntu-latest
    steps:
      - name: ⭐ Retrieve all repo
        run: |+
          mkdir test && cd test
          git clone https://github.com/Pixailz/ft_libft
          rm -rf ft_libft/rsc/helper
          git clone https://github.com/Pixailz/helper ft_libft/rsc/helper
          git clone https://github.com/Pixailz/ft_ping
          rm -rf ft_ping/{lib/ft_libft,rsc/helper}
          cp -r {,ft_ping/lib/}ft_libft
          cp -r ft_ping/{lib/ft_libft/rsc/helper,rsc/helper}
          git clone https://github.com/Pixailz/SupaBlank
          rm -rf SupaBlank/{lib/ft_libft,rsc/helper}
          cp -r {,SupaBlank/lib/}ft_libft
          cp -r SupaBlank/{lib/ft_libft/rsc/helper,rsc/helper}
          git config --global user.name ${{ github.actor }}
          git config --global user.email ${{ github.actor }}

      - name: ⭐ Git commit all
        run: |+
          cd test/ft_libft
          git add rsc/helper
          git commit -m "${{ github.event.inputs.commit_msg }}"
          cd ../ft_ping
          rm -rf lib/ft_libft
          cp -r ../ft_libft lib/ft_libft
          cp -r {lib/ft_libft/,}rsc/helper
          git add lib/ft_libft rsc/helper
          git commit -m "${{ github.event.inputs.commit_msg }}"
          cd ../SupaBlank
          rm -rf lib/ft_libft
          cp -r ../ft_libft lib/ft_libft
          cp -r {lib/ft_libft/,}rsc/helper
          git add lib/ft_libft rsc/helper
          git commit -m "${{ github.event.inputs.commit_msg }}"

  test-ft_libft:
    runs-on: ubuntu-latest
    steps:
      - name: 🔧 test ft_libft
        run: make -C test/ft_libft

  push-ft_libft:
    need: test-ft_libft
    runs-on: ubuntu-latest
    steps:
      - name: ✅ ft_libft push
        run: cd test/ft_libft && git push

  test-ft_ping:
    runs-on: ubuntu-latest
    steps:
      - name: 🔧 test ft_libft
        run: make -C test/ft_ping

  push-ft_ping:
    need: test-ft_ping
    runs-on: ubuntu-latest
    steps:
      - name: ✅ ft_ping push
        run: cd test/ft_ping && git push

  test-SupaBlank:
    runs-on: ubuntu-latest
    steps:
      - name: 🔧 test ft_libft
        run: make -C test/SupaBlank

  push-SupaBlank:
    need: test-SupaBlank
    runs-on: ubuntu-latest
    steps:
      - name: ✅ SupaBlank push
        run: cd test/SupaBlank && git push
